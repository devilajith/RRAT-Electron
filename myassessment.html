<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Assessment</title>
    <link rel="stylesheet" href="css/myassessment.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="images/group-40.svg" alt="logo" class="rrat" id="dashboard-link">
            </div>
            <div class="profile-picture">
                <img src="images/user.svg" alt="User" class="profile" id="profile">
                <span id="user-name" class="user-name"></span>
            </div>
        </div>
        <div class="tabs">
            <button class="tab" id="new-assessment">New assessment</button>
            <button class="tab active" id="my-assessments">My assessments</button>
        </div>      
        <div class="content">
            <div id="message-container" class="message-container"></div> <!-- Message container -->
            <table class="assessment-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Assessment Name</th>
                        <th>Delete</th>
                        <th>Export</th>
                        <th>Results</th>
                    </tr>
                </thead>
                <tbody id="assessment-body">
                    <!-- Assessment rows will be dynamically added here -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        document.getElementById('profile').addEventListener('click', function() {
            window.location.href = 'profile.html';
        });

        document.getElementById('new-assessment').addEventListener('click', function() {
            window.location.href = 'dashboard.html';
        });

        document.getElementById('dashboard-link').addEventListener('click', function() {
            window.location.href = 'dashboard.html';
        });

        document.addEventListener('DOMContentLoaded', () => {
            const userId = sessionStorage.getItem('userId');
            if (userId) {
                window.electron.send('get-profile', userId);
                window.electron.receive('profile-data', (response) => {
                    if (response.success && response.data) {
                        document.getElementById('user-name').textContent = response.data.name;
                    } else {
                        console.error('Failed to load profile data');
                    }
                });
            }

            // Load assessments data and populate the table
            loadAssessments();
        });

        async function loadAssessments() {
            try {
                const assessments = await window.electron.invoke('load-assessments');
                const tbody = document.getElementById('assessment-body');
                assessments.forEach(assessment => {
                    const row = document.createElement('tr');

                    const dateCell = document.createElement('td');
                    dateCell.textContent = assessment.date;
                    row.appendChild(dateCell);

                    const timeCell = document.createElement('td');
                    timeCell.textContent = assessment.time;
                    row.appendChild(timeCell);

                    const nameCell = document.createElement('td');
                    nameCell.textContent = assessment.name;
                    row.appendChild(nameCell);

                    const deleteCell = document.createElement('td');
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.addEventListener('click', async () => {
                        const response = await window.electron.invoke('delete-assessment', assessment.file);
                        if (response.success) {
                            row.remove();
                            showMessage(response.message, 'success');
                        } else {
                            showMessage(response.message, 'error');
                        }
                    });
                    deleteCell.appendChild(deleteButton);
                    row.appendChild(deleteCell);

                    const exportCell = document.createElement('td');
                    const exportButton = document.createElement('button');
                    exportButton.textContent = 'Export';
                    exportButton.addEventListener('click', async () => {
                        const response = await window.electron.invoke('export-assessment', assessment.file);
                        showMessage(response.message, response.success ? 'success' : 'error');
                    });
                    exportCell.appendChild(exportButton);
                    row.appendChild(exportCell);

                    const resultsCell = document.createElement('td');
                    const resultsButton = document.createElement('button');
                    resultsButton.textContent = 'Results';
                    resultsButton.addEventListener('click', () => {
                        window.location.href = `analytics.html?file=${encodeURIComponent(assessment.file)}`;
                    });
                    resultsCell.appendChild(resultsButton);
                    row.appendChild(resultsCell);

                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Failed to load assessments', error);
            }
        }

        let messageTimeout;

        function showMessage(message, type) {
            const messageContainer = document.getElementById('message-container');
            messageContainer.textContent = message;
            messageContainer.className = `message-container ${type}`;
            messageContainer.style.display = 'block';

            // Clear any existing timeout
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }

            // Set a timeout to hide the message after 2 seconds
            messageTimeout = setTimeout(() => {
                messageContainer.className = 'message-container';
                messageContainer.style.display = 'none';
            }, 2000);
        }
    </script>
</body>
</html>